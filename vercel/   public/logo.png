<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>role verification</title>
  <style>
    :root {
      --primary: #3458EA;
      --success: #63AD14;
      --highlight: #FFCC00;
      --background: #F4F7FB;
      --text-color: #111;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--background);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      margin: 0;
    }

    header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 30px;
    }

    header img {
      height: 60px;
      object-fit: contain;
    }

    header h1 {
      font-size: 1.9rem;
      margin: 0;
      color: var(--primary);
    }

    main {
      width: 100%;
      max-width: 650px;
      background: #fff;
      padding: 35px;
      border-radius: 14px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      border-top: 5px solid var(--primary);
    }

    .steps {
      display: flex;
      justify-content: space-between;
      margin-bottom: 25px;
    }

    .step {
      flex: 1;
      text-align: center;
      position: relative;
      font-size: 0.95rem;
      color: var(--primary);
      font-weight: 500;
    }

    .step.active {
      font-weight: bold;
      color: var(--highlight);
    }

    .step::before {
      content: '';
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--primary);
      display: block;
      margin: 0 auto 6px;
    }

    .step.active::before {
      background: var(--highlight);
    }

    .step::after {
      content: '';
      position: absolute;
      top: 7px;
      left: 50%;
      height: 2px;
      width: 100%;
      background: var(--primary);
      z-index: -1;
    }

    .step:last-child::after { display: none; }
    .step.active + .step::after { background: var(--highlight); }

    /* wallet buttons UI */
    .wallet-btns {
      display: flex;
      gap: 10px;
      margin: 12px 0 18px;
    }
    .wallet-btn {
      flex: 1;
      padding: 12px 0;
      border-radius: 10px;
      border: none;
      font-weight: 700;
      cursor: pointer;
      color: #fff;
      transition: 0.2s;
    }
    .wallet-btn:hover { filter: brightness(1.08); }
    .wallet-btn.injected { background: #3458EA; }
    .wallet-btn.walletconnect { background: #3B99FC; }
    .wallet-btn.waap { background: #8A2BE2; }

    input#msg {
      width: 100%;
      font-family: monospace;
      font-size: 0.75rem;
      padding: 12px;
      margin-bottom: 20px;
      border: 2px solid var(--primary);
      border-radius: 10px;
      background: #fff;
      color: var(--text-color);
    }

    button#signBtn {
      padding: 14px 0;
      font-size: 1.1rem;
      border: none;
      border-radius: 10px;
      background: var(--primary);
      color: #fff;
      cursor: pointer;
      transition: 0.3s all;
      width: 100%;
      font-weight: 600;
      position: relative;
      overflow: hidden;
    }

    button#signBtn:hover {
      background: #2c47bf;
    }

    button.loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 24px;
      height: 24px;
      margin: -12px 0 0 -12px;
      border: 3px solid #fff;
      border-top: 3px solid var(--highlight);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      z-index: 10;
    }

    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }

    #status {
      margin-top: 20px;
      font-size: 1rem;
      color: var(--primary);
      white-space: pre-wrap;
    }

    #signature {
      margin-top: 10px;
      font-size: 0.95rem;
      color: var(--success);
      word-break: break-word;
      font-family: monospace;
    }
  </style>
</head>
<body>

  <header>
    <img src="/logo.png" alt="human.tech Logo">
    <h1>role verification</h1>
  </header>

  <main>
    <div class="steps">
      <div class="step" id="step1">Connect</div>
      <div class="step" id="step2">Sign</div>
      <div class="step" id="step3">Submit</div>
      <div class="step" id="step4">Verified</div>
    </div>

    <p>Connect your wallet used for the covenant and sign the challenge below.</p>

    <div class="wallet-btns">
      <button class="wallet-btn injected" id="btnInjected" type="button">Browser Wallet</button>
      <button class="wallet-btn walletconnect" id="btnWC" type="button">WalletConnect</button>
      <button class="wallet-btn waap" id="btnWaaP" type="button">WaaP.xyz</button>
    </div>

    <input type="text" id="msg" readonly>

    <button id="signBtn" type="button">Connect & Sign</button>

    <p id="status"></p>
    <p id="signature"></p>
  </main>

  <!-- Keep: ethers UMD (known working) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>

  <!-- ✅ NEW: self-hosted bundle (Reown AppKit + WaaP) -->
  <!-- This file is generated at build time into: public/vendor/wallets.bundle.js -->
  <script src="/vendor/wallets.bundle.js"></script>

  <script>
    // Surface errors in UI (helps inside Discord browsers)
    window.addEventListener("error", (e) => {
      const el = document.getElementById("status");
      if (el) el.innerText = "❌ JS error: " + (e.message || "Unknown");
    });
    window.addEventListener("unhandledrejection", (e) => {
      const el = document.getElementById("status");
      if (el) el.innerText = "❌ Promise error: " + (e.reason?.message || e.reason || "Unknown");
    });

    document.addEventListener("DOMContentLoaded", () => {
      const WALLETCONNECT_PROJECT_ID = "458187c5895e1cb056679eedabc8f362";

      const params = new URLSearchParams(window.location.search);
      const challenge = params.get("challenge") || "";
      const userId = params.get("userId");

      const msgInput = document.getElementById("msg");
      const status = document.getElementById("status");
      const sigOutput = document.getElementById("signature");
      const btn = document.getElementById("signBtn");

      const step1 = document.getElementById("step1");
      const step2 = document.getElementById("step2");
      const step3 = document.getElementById("step3");
      const step4 = document.getElementById("step4");

      const btnInjected = document.getElementById("btnInjected");
      const btnWC = document.getElementById("btnWC");
      const btnWaaP = document.getElementById("btnWaaP");

      msgInput.value = challenge || "❌ No challenge received";

      let signer;
      let selected = "injected";
      let appkit = null; // Reown AppKit instance

      function setStatus(t) { status.innerText = t; }

      function updateStep(stepNum) {
        [step1, step2, step3, step4].forEach((el, idx) => {
          el.classList.toggle("active", idx < stepNum);
        });
      }

      async function submitSignature(sig) {
        step3.classList.add("active");
        btn.classList.remove("loading");
        try {
          sigOutput.innerText = sig;
          setStatus("Submitting signature to bot...");
          const resp = await fetch("/api/signature", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId: userId.toString(), signature: sig })
          });
          const result = await resp.json();
          if (result.success) {
            step4.classList.add("active");
            setStatus("✅ Verified! Role assigned. Private channel will auto-delete.");
          } else {
            setStatus("❌ Verification failed: " + (result.error || "Unknown error"));
          }
        } catch (err) {
          console.error(err);
          setStatus("❌ Error submitting signature: " + (err.message || err));
        }
      }

      async function signChallenge() {
        step2.classList.add("active");
        const sig = await signer.signMessage(challenge);
        await submitSignature(sig);
      }

      // 1) Injected (known working)
      async function connectInjected() {
        if (!window.ethereum) {
          throw new Error("No browser wallet detected. Try WalletConnect or WaaP, or open in MetaMask/Rabby browser.");
        }
        const provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        return provider.getSigner();
      }

      // 2) WalletConnect via Reown AppKit (Option B)
      async function connectWithAppKit() {
        if (!window.__reown?.createAppKit) {
          throw new Error("Reown AppKit not loaded. Did /vendor/wallets.bundle.js build and deploy?");
        }

        if (!appkit) {
          const { createAppKit, EthersAdapter, mainnet, base } = window.__reown;
          const ethersAdapter = new EthersAdapter();

          appkit = createAppKit({
            adapters: [ethersAdapter],
            networks: [mainnet, base],
            projectId: WALLETCONNECT_PROJECT_ID,
            metadata: {
              name: "role verification",
              description: "Sign a challenge to verify and receive a Discord role",
              url: window.location.origin,
              icons: [window.location.origin + "/logo.png"]
            }
          });
        }

        appkit.open({ view: "Connect", namespace: "eip155" });

        const eip155Provider = await new Promise((resolve, reject) => {
          const timeout = setTimeout(() => reject(new Error("Timed out waiting for wallet connection.")), 60000);

          const unsub = appkit.subscribeProviders((state) => {
            const p = state && state["eip155"];
            if (p) {
              clearTimeout(timeout);
              try { unsub && unsub(); } catch (_) {}
              resolve(p);
            }
          });
        });

        appkit.close();

        const provider = new ethers.BrowserProvider(eip155Provider);
        await provider.send("eth_requestAccounts", []);
        return provider.getSigner();
      }

      // 3) WaaP.xyz
      async function connectWaaP() {
        if (!window.__initWaaP) {
          throw new Error("WaaP SDK not loaded. Did /vendor/wallets.bundle.js build and deploy?");
        }

        window.__initWaaP({
          config: {
            authenticationMethods: ["wallet"],
            styles: { darkMode: false }
          },
          walletConnectProjectId: WALLETCONNECT_PROJECT_ID,
          project: { name: "role verification" }
        });

        if (!window.waap?.login) {
          throw new Error("WaaP did not initialize (window.waap missing).");
        }

        const loginType = await window.waap.login();
        if (!loginType) throw new Error("WaaP login cancelled.");

        const provider = new ethers.BrowserProvider(window.waap);
        await provider.send("eth_requestAccounts", []);
        return provider.getSigner();
      }

      // UI events
      btnInjected.addEventListener("click", () => { selected = "injected"; setStatus("Selected: Browser Wallet"); });
      btnWC.addEventListener("click", () => { selected = "walletconnect"; setStatus("Selected: WalletConnect (AppKit)"); });
      btnWaaP.addEventListener("click", () => { selected = "waap"; setStatus("Selected: WaaP.xyz"); });

      btn.addEventListener("click", async () => {
        updateStep(1);
        btn.classList.add("loading");
        setStatus("Connecting...");

        try {
          if (selected === "injected") signer = await connectInjected();
          else if (selected === "walletconnect") signer = await connectWithAppKit();
          else if (selected === "waap") signer = await connectWaaP();
          else throw new Error("Unknown wallet selection.");

          setStatus("Wallet connected. Awaiting signature approval...");
          await signChallenge();
        } catch (err) {
          console.error(err);
          btn.classList.remove("loading");
          setStatus("❌ Wallet connection/signing error: " + (err.message || err));
        }
      });

      setStatus("Ready. Choose a wallet then click Connect & Sign.");
    });
  </script>
</body>
</html>
