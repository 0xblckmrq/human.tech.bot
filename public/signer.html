<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>role verification</title>
  <style>
    :root {
      --primary: #3458EA;
      --success: #63AD14;
      --highlight: #FFCC00;
      --background: #F4F7FB;
      --text-color: #111;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--background);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      margin: 0;
    }

    header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 30px;
    }

    header img {
      height: 60px;
      object-fit: contain;
    }

    header h1 {
      font-size: 1.9rem;
      margin: 0;
      color: var(--primary);
    }

    main {
      width: 100%;
      max-width: 650px;
      background: #fff;
      padding: 35px;
      border-radius: 14px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      border-top: 5px solid var(--primary);
    }

    .steps {
      display: flex;
      justify-content: space-between;
      margin-bottom: 25px;
    }

    .step {
      flex: 1;
      text-align: center;
      position: relative;
      font-size: 0.95rem;
      color: var(--primary);
      font-weight: 500;
    }

    .step.active {
      font-weight: bold;
      color: var(--highlight);
    }

    .step::before {
      content: '';
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--primary);
      display: block;
      margin: 0 auto 6px;
    }

    .step.active::before {
      background: var(--highlight);
    }

    .step::after {
      content: '';
      position: absolute;
      top: 7px;
      left: 50%;
      height: 2px;
      width: 100%;
      background: var(--primary);
      z-index: -1;
    }

    .step:last-child::after { display: none; }
    .step.active + .step::after { background: var(--highlight); }

    .wallet-btns {
      display: flex;
      gap: 10px;
      margin: 12px 0 18px;
    }
    .wallet-btn {
      flex: 1;
      padding: 12px 0;
      border-radius: 10px;
      border: none;
      font-weight: 700;
      cursor: pointer;
      color: #fff;
      transition: 0.2s;
    }
    .wallet-btn:hover { filter: brightness(1.08); }
    .wallet-btn.injected { background: #3458EA; }
    .wallet-btn.walletconnect { background: #3B99FC; }
    .wallet-btn.waap { background: #8A2BE2; }

    input#msg {
      width: 100%;
      font-family: monospace;
      font-size: 0.75rem;
      padding: 12px;
      margin-bottom: 20px;
      border: 2px solid var(--primary);
      border-radius: 10px;
      background: #fff;
      color: var(--text-color);
    }

    button#signBtn {
      padding: 14px 0;
      font-size: 1.1rem;
      border: none;
      border-radius: 10px;
      background: var(--primary);
      color: #fff;
      cursor: pointer;
      transition: 0.3s all;
      width: 100%;
      font-weight: 600;
      position: relative;
      overflow: hidden;
    }

    button#signBtn:hover {
      background: #2c47bf;
    }

    button.loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 24px;
      height: 24px;
      margin: -12px 0 0 -12px;
      border: 3px solid #fff;
      border-top: 3px solid var(--highlight);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      z-index: 10;
    }

    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }

    #status {
      margin-top: 20px;
      font-size: 1rem;
      color: var(--primary);
      white-space: pre-wrap;
    }

    #signature {
      margin-top: 10px;
      font-size: 0.95rem;
      color: var(--success);
      word-break: break-word;
      font-family: monospace;
    }
  </style>
</head>
<body>
<header>
  <img src="/logo.png" alt="human.tech Logo">
  <h1>role verification</h1>
</header>

<main>
  <div class="steps">
    <div class="step" id="step1">Connect</div>
    <div class="step" id="step2">Sign</div>
    <div class="step" id="step3">Submit</div>
    <div class="step" id="step4">Verified</div>
  </div>

  <p>Connect your wallet used for the covenant and sign the challenge below.</p>

  <div id="walletRow" style="display:none; margin: 14px 0 18px; padding: 12px 14px; border: 1px solid rgba(0,0,0,0.08); border-radius: 12px; background: rgba(52,88,234,0.04);">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
      <div style="min-width: 280px; flex: 1;">
        <div style="font-size:0.85rem; color: rgba(17,17,17,0.65); margin-bottom:4px;">Linked wallet (current)</div>
        <div id="linkedWallet" style="font-family: monospace; font-size:0.95rem; word-break: break-all;"></div>

        <div id="connectedWalletWrap" style="margin-top:10px; display:none;">
          <div style="font-size:0.85rem; color: rgba(17,17,17,0.65); margin-bottom:4px;">Wallet you just connected</div>
          <div id="connectedWalletNow" style="font-family: monospace; font-size:0.95rem; word-break: break-all;"></div>
        </div>
      </div>

      <button id="changeWalletBtn" type="button" style="padding:10px 14px; border-radius:10px; border: 1px solid rgba(0,0,0,0.12); background:#fff; cursor:pointer; font-weight:700;">
        Change wallet
      </button>
    </div>
  </div>

  <div class="wallet-btns">
    <button class="wallet-btn injected" id="btnInjected" type="button">Browser Wallet</button>
    <button class="wallet-btn walletconnect" id="btnWC" type="button">WalletConnect</button>
    <button class="wallet-btn waap" id="btnWaaP" type="button">WaaP.xyz</button>
  </div>

  <input type="text" id="msg" readonly>
  <button id="signBtn" type="button">Connect & Sign</button>

  <p id="status"></p>
  <p id="signature"></p>
</main>

<script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
<script src="/vendor/wallets.bundle.js"></script>

<script>
  window.addEventListener("error", (e) => {
    const el = document.getElementById("status");
    if (el) el.innerText = "❌ JS error: " + (e.message || "Unknown");
  });
  window.addEventListener("unhandledrejection", (e) => {
    const el = document.getElementById("status");
    if (el) el.innerText = "❌ Promise error: " + (e.reason?.message || e.reason || "Unknown");
  });

  document.addEventListener("DOMContentLoaded", () => {
    const WALLETCONNECT_PROJECT_ID = "458187c5895e1cb056679eedabc8f362";

    const params = new URLSearchParams(window.location.search);
    const challenge = params.get("challenge") || "";
    const userId = params.get("userId");

    const msgInput = document.getElementById("msg");
    const status = document.getElementById("status");
    const sigOutput = document.getElementById("signature");
    const btn = document.getElementById("signBtn");

    const step1 = document.getElementById("step1");
    const step2 = document.getElementById("step2");
    const step3 = document.getElementById("step3");
    const step4 = document.getElementById("step4");

    const btnInjected = document.getElementById("btnInjected");
    const btnWC = document.getElementById("btnWC");
    const btnWaaP = document.getElementById("btnWaaP");

    msgInput.value = challenge || "❌ No challenge received";

    let signer;
    let selected = "injected";
    let appkit = null;

    let sessionWallet = null;
    let walletChangeRequested = false;
    let lastStatus = null;

    function setStatus(t) { status.innerText = t; }
    function updateStep(stepNum) {
      [step1, step2, step3, step4].forEach((el, idx) => el.classList.toggle("active", idx < stepNum));
    }

    const walletRow = document.getElementById("walletRow");
    const linkedWalletEl = document.getElementById("linkedWallet");
    const connectedWalletNowEl = document.getElementById("connectedWalletNow");
    const connectedWalletWrap = document.getElementById("connectedWalletWrap");
    const changeWalletBtn = document.getElementById("changeWalletBtn");

    function showLinkedWallet(wallet) {
      if (!walletRow || !linkedWalletEl) return;
      linkedWalletEl.innerText = wallet;
      walletRow.style.display = "block";
    }

    function showConnectedWalletNow(wallet) {
      if (!connectedWalletWrap || !connectedWalletNowEl) return;
      connectedWalletNowEl.innerText = wallet;
      connectedWalletWrap.style.display = "block";
      if (walletRow) walletRow.style.display = "block";
    }

    async function loadStatus() {
      try {
        if (!userId) return null;
        const resp = await fetch("https://human-tech-bot.onrender.com/api/status?userId=" + encodeURIComponent(userId.toString()), {
          method: "GET",
          headers: { "Accept": "application/json" }
        });
        const result = await resp.json();
        lastStatus = result;

        if (result && result.success) {
          const wallet = result?.inputs?.wallet || result?.wallet || null;
          sessionWallet = wallet ? String(wallet).toLowerCase() : null;
          if (wallet) showLinkedWallet(wallet);
        }

        return result;
      } catch (e) {
        console.warn("Status load failed:", e?.message || e);
        return null;
      }
    }

    if (changeWalletBtn) {
      changeWalletBtn.addEventListener("click", () => {
        walletChangeRequested = true;
        document.querySelector(".wallet-btns").style.display = "flex";
        btn.style.display = "block";
        setStatus("Changing wallet: choose a wallet then click Connect & Sign.");
      });
    }

    async function submitSignature(sig) {
      step3.classList.add("active");
      btn.classList.remove("loading");
      try {
        sigOutput.innerText = sig;
        setStatus("Submitting signature to bot...");

        const resp = await fetch("https://human-tech-bot.onrender.com/api/signature", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId: userId.toString(), signature: sig })
        });
        const result = await resp.json();

        if (result.success) {
          step4.classList.add("active");
          const wallet = result?.inputs?.wallet || result?.wallet;
          if (wallet) showLinkedWallet(wallet);
          btn.style.display = "none";
          document.querySelector(".wallet-btns").style.display = "none";
          setStatus("This private channel will auto-delete.");
          return;
        }

        const errMsg = (result?.error || "").toLowerCase();
        if (errMsg.includes("no active verification")) {
          // We still attempted signing as requested; backend has no session.
          setStatus("❌ No active verification on the bot. Please run /verify again to generate a fresh link.");
          return;
        }

        setStatus("❌ Verification failed: " + (result.error || "Unknown error"));
      } catch (err) {
        console.error(err);
        setStatus("❌ Error submitting signature: " + (err.message || err));
      }
    }

    async function signChallenge() {
      if (!challenge) {
        throw new Error("No challenge in the URL. Please run /verify again to generate a fresh link.");
      }
      step2.classList.add("active");
      const sig = await signer.signMessage(challenge);
      await submitSignature(sig);
    }

    async function connectInjected() {
      if (!window.ethereum) {
        throw new Error("No browser wallet detected. Try WalletConnect or WaaP, or open in MetaMask/Rabby browser.");
      }
      const provider = new ethers.BrowserProvider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      return provider.getSigner();
    }

    async function connectWithAppKit() {
      if (!window.__reown?.createAppKit) {
        throw new Error("Reown AppKit not loaded. Did /vendor/wallets.bundle.js build and deploy?");
      }

      if (!appkit) {
        const { createAppKit, EthersAdapter, mainnet, base } = window.__reown;
        const ethersAdapter = new EthersAdapter();

        appkit = createAppKit({
          adapters: [ethersAdapter],
          networks: [mainnet, base],
          projectId: WALLETCONNECT_PROJECT_ID,
          metadata: {
            name: "role verification",
            description: "Sign a challenge to verify and receive a Discord role",
            url: window.location.origin,
            icons: [window.location.origin + "/logo.png"]
          }
        });
      }

      appkit.open({ view: "Connect", namespace: "eip155" });

      const eip155Provider = await new Promise((resolve, reject) => {
        const timeout = setTimeout(() => reject(new Error("Timed out waiting for wallet connection.")), 60000);
        const unsub = appkit.subscribeProviders((state) => {
          const p = state && state["eip155"];
          if (p) {
            clearTimeout(timeout);
            try { unsub && unsub(); } catch (_) {}
            resolve(p);
          }
        });
      });

      appkit.close();

      const provider = new ethers.BrowserProvider(eip155Provider);
      await provider.send("eth_requestAccounts", []);
      return provider.getSigner();
    }

    async function connectWaaP() {
      if (!window.__initWaaP) {
        throw new Error("WaaP SDK not loaded. Did /vendor/wallets.bundle.js build and deploy?");
      }

      window.__initWaaP({
        config: { authenticationMethods: ["wallet"], styles: { darkMode: false } },
        walletConnectProjectId: WALLETCONNECT_PROJECT_ID,
        project: { name: "role verification" }
      });

      if (!window.waap?.login) {
        throw new Error("WaaP did not initialize (window.waap missing).");
      }

      const loginType = await window.waap.login();
      if (!loginType) throw new Error("WaaP login cancelled.");

      const provider = new ethers.BrowserProvider(window.waap);
      await provider.send("eth_requestAccounts", []);
      return provider.getSigner();
    }

    btnInjected.addEventListener("click", () => { selected = "injected"; setStatus("Selected: Browser Wallet"); });
    btnWC.addEventListener("click", () => { selected = "walletconnect"; setStatus("Selected: WalletConnect (AppKit)"); });
    btnWaaP.addEventListener("click", () => { selected = "waap"; setStatus("Selected: WaaP.xyz"); });

    btn.addEventListener("click", async () => {
      updateStep(1);
      btn.classList.add("loading");
      setStatus("Connecting...");

      try {
        // Load status if available, but NEVER block signing if session is missing.
        await loadStatus();

        if (selected === "injected") signer = await connectInjected();
        else if (selected === "walletconnect") signer = await connectWithAppKit();
        else if (selected === "waap") signer = await connectWaaP();
        else throw new Error("Unknown wallet selection.");

        // Always show connected wallet
        const addr = await signer.getAddress();
        showConnectedWalletNow(addr);

        // If same wallet is known, you can optionally call confirm-wallet here;
        // but if sessionWallet is missing, we still proceed to sign.
        setStatus("Wallet connected. Awaiting signature approval...");
        await signChallenge();
      } catch (err) {
        console.error(err);
        btn.classList.remove("loading");
        setStatus("❌ Wallet connection/signing error: " + (err.message || err));
      }
    });

    setStatus("Ready. Choose a wallet then click Connect & Sign.");
    loadStatus();
  });
</script>
</body>
</html>
